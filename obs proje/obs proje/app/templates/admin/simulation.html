{% extends "base.html" %}

{% block title %}Kayıt Simülasyonu{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="page-header">
        <h1><i class="fas fa-play-circle"></i> Kayıt Simülasyonu</h1>
        <p>Toplu kayıt işlemini simüle edin</p>
    </div>
    
    <!-- Simülasyon Kontrolleri -->
    <div class="simulation-controls">
        <div class="control-card">
            <h3><i class="fas fa-play"></i> Yeni Simülasyon</h3>
            <p>Tüm öğrencilerin ders taleplerini öncelik sırasına göre işle</p>
            <form method="POST" action="{{ url_for('admin.run_simulation') }}" class="inline-form">
                <select name="semester" class="form-select">
                    <option value="2024-Güz">2024 Güz</option>
                    <option value="2024-Bahar">2024 Bahar</option>
                    <option value="2025-Güz">2025 Güz</option>
                </select>
                <button type="submit" class="btn btn-primary" onclick="this.disabled=true; this.innerHTML='<i class=\'fas fa-spinner fa-spin\'></i> İşleniyor...'; this.form.submit();">
                    <i class="fas fa-play"></i> Simülasyonu Başlat
                </button>
            </form>
        </div>
        
        <div class="control-card">
            <h3><i class="fas fa-undo"></i> Sıfırla</h3>
            <p>Tüm kayıtları ve kontenjanları sıfırla (test amaçlı)</p>
            <form method="POST" action="{{ url_for('admin.reset_simulation') }}" 
                  onsubmit="return confirm('Bu işlem tüm kayıtları silecek. Emin misiniz?');">
                <select name="semester" class="form-select">
                    <option value="2024-Güz">2024 Güz</option>
                </select>
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Sıfırla
                </button>
            </form>
        </div>
    </div>
    
    <!-- Geçmiş Simülasyonlar -->
    <div class="simulations-history">
        <h2><i class="fas fa-history"></i> Geçmiş Simülasyonlar</h2>
        
        {% if simulations %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Dönem</th>
                            <th>Tarih</th>
                            <th>Toplam Talep</th>
                            <th>Onaylanan</th>
                            <th>Reddedilen</th>
                            <th>Onay Oranı</th>
                            <th>Süre</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sim in simulations %}
                            <tr>
                                <td>#{{ sim.id }}</td>
                                <td>{{ sim.semester }}</td>
                                <td>{{ sim.completed_at.strftime('%d.%m.%Y %H:%M') if sim.completed_at else '-' }}</td>
                                <td>{{ sim.total_requests }}</td>
                                <td class="text-success">{{ sim.total_approved }}</td>
                                <td class="text-danger">{{ sim.total_rejected }}</td>
                                <td>%{{ "%.1f"|format(sim.avg_approval_rate) }}</td>
                                <td>{{ "%.2f"|format(sim.processing_time_seconds) }}s</td>
                                <td>
                                    <a href="{{ url_for('admin.simulation_result', simulation_id=sim.id) }}" class="btn btn-sm btn-outline">
                                        <i class="fas fa-chart-bar"></i> Rapor
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-play-circle"></i>
                <h3>Henüz simülasyon yok</h3>
                <p>İlk simülasyonu başlatmak için yukarıdaki butonu kullanın.</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Bilgi Kutusu -->
    <div class="info-box">
        <h4><i class="fas fa-info-circle"></i> Simülasyon Nasıl Çalışır?</h4>
        <ol>
            <li><strong>Öncelik Hesaplama:</strong> Tüm öğrencilerin öncelik puanları hesaplanır.</li>
            <li><strong>Sıralama:</strong> Öğrenciler öncelik puanına göre yüksekten düşüğe sıralanır.</li>
            <li><strong>İşleme:</strong> Her öğrencinin ders talepleri sırasıyla işlenir:
                <ul>
                    <li>Kontenjan kontrolü yapılır</li>
                    <li>Ön şart kontrolü yapılır</li>
                    <li>Çakışma kontrolü yapılır</li>
                </ul>
            </li>
            <li><strong>Kayıt:</strong> Uygun dersler onaylanır, uygun olmayanlar reddedilir.</li>
            <li><strong>Raporlama:</strong> Sonuçlar ve metrikler kaydedilir.</li>
        </ol>
    </div>
</div>
{% endblock %}
